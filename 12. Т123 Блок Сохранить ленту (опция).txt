<script>
    /* ===== Сохранение и восстановление ленты ответов ===== */
const STORAGE_KEY = "nm_generated_feed_" + window.location.pathname;

// Восстановление при загрузке страницы
window.addEventListener("DOMContentLoaded", () => {
  initStorage();
  attachCopyListeners();
});

function initStorage() {
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const feed = App.selectors.generatedContent;
  if (feed && saved.length) {
    saved.forEach(html => {
      const block = document.createElement("div");
      block.className = "feedItem";
      block.innerHTML = html;
      
      feed.prepend(block);
      const decreaseButton = block.querySelector('.decrease');
      const increaseButton = block.querySelector('.increase');
      if (changeFontSize && decreaseButton && increaseButton) {
        decreaseButton.addEventListener("click", (e) => {
            changeFontSize(e, 'decrease');
        });
        increaseButton.addEventListener("click", (e) => {
            changeFontSize(e, 'increase');
        });
      }
      if (typeof addAudioButton === 'function') {
          const buttonsContainer = block.querySelector('.form4__btns_container');
          const paragraph = block.querySelector('.form4__paragraph');
          const num = Number(block.querySelector('.form4__paragraph').id.replace('answer', ''));
          
          addAudioButton(num, paragraph.textContent, buttonsContainer);
      }
      if (typeof addShareButton === 'function') {
          const buttonsContainer = block.querySelector('.form4__btns_container');
          const paragraph = block.querySelector('.form4__paragraph');
          const num = Number(block.querySelector('.form4__paragraph').id.replace('answer', ''));
          
          addShareButton(num, paragraph.textContent, buttonsContainer);
      }
      //feed.prepend(block);  // ✅ новые сверху, старые вниз
    });
  }
}

// Функция добавления ответа в ленту + сохранения
function addToFeed(htmlContent) {
  // не сохраняем временный блок
    if (htmlContent.includes(App.config.textPlaceholder)) return;

  // только сохраняем
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  saved.push(htmlContent);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
}

// Очистка ленты (по кнопке, если захочешь)
function clearFeed() {
  localStorage.removeItem(STORAGE_KEY);
  const feed = App.selectors.generatedContent;
  if (feed) feed.innerHTML = "";
}
/* ===== Кнопка "Очистить ленту" ===== */
function ensureClearButton() {
  const form1 = App.selectors.form;
  const feed = App.selectors.generatedContent;

  // если кнопка уже есть — ничего не делаем
  if (document.getElementById("clearFeedBtn")) return;

  // показываем кнопку только если есть ответы
  if (feed && feed.children.length > 0) {
    const btn = document.createElement("button");
    btn.id = "clearFeedBtn";
    btn.type = "button";
    btn.textContent = "Очистить ленту";
    btn.className = "clearFeedBtn"; // отдельный класс для стилей

    btn.addEventListener("click", () => {
      clearFeed();
      btn.remove(); // убираем кнопку после очистки
    });

    // ???? вставляем кнопку прямо в конец формы
    form1.appendChild(btn);
  }
}

window.addEventListener('responseHtmlCreated', (e) => {
  const {num, responseHtml} = e.detail;
  addToFeed(responseHtml);
  ensureClearButton();
})

// вызываем при восстановлении ленты
window.addEventListener("DOMContentLoaded", () => {
  ensureClearButton();
});



</script>