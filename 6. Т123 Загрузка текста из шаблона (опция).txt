<script>

function exportToJson(event, filename = 'template', form = document.getElementById('form1')) {
    event.preventDefault();
    const {message, messageData} = calculateFormData(form);
    const blob = new Blob([JSON.stringify(message, null, 2)], { type: 'application/json' });
    
    // Создаем ссылку для скачивания
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function handleJsonDefaultUpload(event, formId) {

    try {
        const form = document.getElementById(formId);
        if (!form) {
            console.error('Форма с ID "' + formId + '" не найдена.');
            return;
        }
        
        for (const id of Object.keys(defaultTemplate)) {
            const input = form.querySelector(`#${id}`);
            if (!input) {
                alert('Данный шаблон не подходит к данной форме.');
                return; // Прерываем выполнение, если найден хотя бы один несовместимый ID
            }
            if (input.type !== 'file') {
                input.value = defaultTemplate[id];
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
    } catch (error) {
        console.error('Ошибка при обработке стандартного шаблона:', error);
        alert('Произошла ошибка при обработке стандартного шаблона.');
    }

}

function handleJsonUpload(event, formId) {
    const file = event.target.files[0];
    if (!file || file.type !== 'application/json') {
        alert('Пожалуйста, выберите JSON файл.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = JSON.parse(e.target.result);
            const form = document.getElementById(formId);
            if (!form) {
                console.error('Форма с ID "' + formId + '" не найдена.');
                return;
            }
            
            let invalidTemplate = false; // Флаг для отслеживания ошибки шаблона
            
            for (const id of Object.keys(content)) {
                const input = form.querySelector(`#${id}`);
                if (!input) {
                    alert('Данный шаблон не подходит к данной форме.');
                    return; // Прерываем выполнение, если найден хотя бы один несовместимый ID
                }
                if (input.type !== 'file') {
                    input.value = content[id];
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        } catch (error) {
            console.error('Ошибка при разборе JSON:', error);
            alert('Некорректный JSON файл.');
        }
    };
    reader.readAsText(file);
}

document.addEventListener("DOMContentLoaded", () => {
  // Создание кнопок сохранения и загрузки шаблона
  const buttonsContainer = document.querySelector('.form1__button_container');
  
  const container = document.createElement('div');
  container.classList.add('template__container');
  
  const label = document.createElement('div');
  label.classList.add('form1__label');
  label.textContent = 'Шаблон';
  
  const templateButtonsContainer = document.createElement('div');
  templateButtonsContainer.classList.add('form1__template-button_container');
  
  container.appendChild(label);

  const loadButton = document.createElement("button");
  loadButton.className = "form1__template-button template-buttons";
  loadButton.id = "load-button";
  loadButton.textContent = "Загрузить";
  loadButton.setAttribute('data-goal', 'form_load_template');
  
  loadButton.addEventListener("click", (event) => {
    openTemplateModal(event);
  });

  templateButtonsContainer.appendChild(loadButton);

  const downloadButton = document.createElement("button");
  downloadButton.className = "form1__template-button template-buttons";
  downloadButton.id = "download-button";
  downloadButton.textContent = "Сохранить";
  downloadButton.setAttribute('data-goal', 'form_save_template');

  downloadButton.addEventListener("click", (event) => {
    openConfirmModal(
      event,
      "Файл будет сохранен на ваш компьютер. Продолжить?",
      exportToJson
    );
  });

  templateButtonsContainer.appendChild(downloadButton);
  container.appendChild(templateButtonsContainer)
  
  buttonsContainer.appendChild(container);

});

</script>